pipeline {
    agent any

    environment {
        // Database
        DB_USERNAME = "root"
        DB_PASSWORD = "tarik123"
        DB_URL = "jdbc:mysql://mysql:3306/online_library?useSSL=false&allowPublicKeyRetrieval=true&serverTimezone=UTC"

        // Docker
        DOCKER_IMAGE = "onlinebiblio"
        DOCKER_TAG = "${BUILD_NUMBER}"
        DOCKER_REGISTRY = "tarik123abc"

        // Kubernetes
        K8S_NAMESPACE = "online-library"
        K8S_DEPLOYMENT_NAME = "online-library"
    }

    stages {

        stage('Clean Workspace') {
            steps {
                echo "Cleaning Jenkins workspace..."
                deleteDir()
            }
        }

        stage('Checkout') {
            steps {
                checkout scm
            }
        }

        stage('Preload Maven Dependencies') {
            steps {
                echo "Preloading Maven dependencies..."
                bat "mvn dependency:go-offline"
            }
        }

        stage('Build & Test') {
            steps {
                echo "Building and testing the application..."
                bat "mvn clean verify"
            }
        }

        stage('Prepare Dependencies for Sonar') {
            steps {
                echo "Copying Maven dependencies..."
                bat "mvn dependency:copy-dependencies -DoutputDirectory=target/dependency"
            }
        }

        stage('SonarQube Analysis') {
            environment {
                SCANNER_HOME = tool name: 'SonarScanner', type: 'hudson.plugins.sonar.SonarRunnerInstallation'
            }
            steps {
                withCredentials([string(credentialsId: 'sonar-token', variable: 'SONAR_AUTH_TOKEN')]) {
                    bat """
                        "%SCANNER_HOME%\\bin\\sonar-scanner.bat" ^
                        -Dsonar.projectKey=onlinebiblio ^
                        -Dsonar.projectName=OnlineBiblio ^
                        -Dsonar.sources=src/main/java ^
                        -Dsonar.tests=src/test/java ^
                        -Dsonar.java.binaries=target/classes ^
                        -Dsonar.java.libraries=target/dependency/*.jar ^
                        -Dsonar.coverage.jacoco.xmlReportPaths=target/jacoco-report/jacoco.xml ^
                        -Dsonar.host.url=http://localhost:9000 ^
                        -Dsonar.token=%SONAR_AUTH_TOKEN%
                    """
                }
            }
        }

        stage('Build Docker Image') {
            steps {
                echo "Building Docker image..."
                bat "docker build -t %DOCKER_IMAGE%:%DOCKER_TAG% ."
                bat "docker tag %DOCKER_IMAGE%:%DOCKER_TAG% %DOCKER_IMAGE%:latest"
            }
        }

        stage('Push to Docker Registry') {
            steps {
                echo "Pushing Docker image to Docker Hub..."
                withCredentials([usernamePassword(
                    credentialsId: 'docker-hub-credentials',
                    usernameVariable: 'DOCKER_USER',
                    passwordVariable: 'DOCKER_PASS'
                )]) {
                    bat "docker login -u %DOCKER_USER% -p %DOCKER_PASS%"
                    bat "docker tag %DOCKER_IMAGE%:%DOCKER_TAG% %DOCKER_REGISTRY%/%DOCKER_IMAGE%:%DOCKER_TAG%"
                    bat "docker push %DOCKER_REGISTRY%/%DOCKER_IMAGE%:%DOCKER_TAG%"
                    bat "docker tag %DOCKER_IMAGE%:%DOCKER_TAG% %DOCKER_REGISTRY%/%DOCKER_IMAGE%:latest"
                    bat "docker push %DOCKER_REGISTRY%/%DOCKER_IMAGE%:latest"
                }
            }
        }

        stage('Verify Kubernetes Cluster') {
            steps {
                echo "Verifying Kubernetes cluster connectivity..."
                bat """
                    minikube status || minikube start
                    timeout /t 10 /nobreak
                    kubectl config use-context minikube
                    kubectl cluster-info
                """
            }
        }

        stage('Verify Kubernetes Cluster') {
            steps {
                echo "Verifying Kubernetes cluster connectivity..."
                bat "kubectl config use-context minikube"
                bat "kubectl cluster-info"
                bat "kubectl get nodes"
            }
        }

        stage('Deploy to Kubernetes') {
            steps {
                echo "Deploying to Kubernetes..."

                // 1️⃣ Namespace
                bat "kubectl apply -f k8s/namespace.yaml"

                // 2️⃣ RBAC
                bat "kubectl apply -f k8s/prometheus-rbac.yaml"

                // 3️⃣ Secrets
                bat "kubectl apply -f k8s/mysql-secret.yaml"

                // 4️⃣ ConfigMaps
                bat "kubectl apply -f k8s/mysql-init-configmap.yaml"
                bat "kubectl apply -f k8s/prometheus-config.yaml"
                bat "kubectl apply -f k8s/grafana-datasources.yaml"
                bat "kubectl apply -f k8s/grafana-dashboard.yaml"

                // 5️⃣ Storage
                bat "kubectl apply -f k8s/mysql-pvc.yaml"

                // 6️⃣ Base de données
                bat "kubectl apply -f k8s/mysql-deployment.yaml"
                bat "kubectl apply -f k8s/mysql-service.yaml"

                echo "Waiting for MySQL to be ready..."
                bat "kubectl wait --for=condition=ready pod -l app=mysql -n %K8S_NAMESPACE% --timeout=300s"
                bat "timeout /t 15 /nobreak"

                // 7️⃣ Application
                bat "kubectl apply -f k8s/app-deployment.yaml"
                bat "kubectl apply -f k8s/app-service.yaml"
                bat "kubectl set image deployment/%K8S_DEPLOYMENT_NAME% online-library=%DOCKER_REGISTRY%/%DOCKER_IMAGE%:%DOCKER_TAG% -n %K8S_NAMESPACE%"
                bat "kubectl rollout status deployment/%K8S_DEPLOYMENT_NAME% -n %K8S_NAMESPACE% --timeout=180s"

                // 8️⃣ Monitoring Stack
                echo "Deploying Monitoring Stack..."
                bat "kubectl apply -f k8s/kube-state-metrics.yaml"
                bat "kubectl apply -f k8s/cadvisor-daemonset.yaml"
                bat "kubectl apply -f k8s/prometheus-deployment.yaml"
                bat "kubectl apply -f k8s/grafana-deployment.yaml"

                // 9️⃣ Ingress
                bat "kubectl apply -f k8s/ingress.yaml"
            }
        }

        stage('Verify Deployment') {
            steps {
                echo "Verifying Kubernetes deployment..."
                bat "kubectl get pods -n %K8S_NAMESPACE%"
                bat "kubectl get services -n %K8S_NAMESPACE%"
                bat "kubectl get pvc -n %K8S_NAMESPACE%"
                echo "=========================================="
                echo "APPLICATION URLS:"
                echo "Application: minikube service online-library-service -n online-library --url"
                echo "Prometheus: minikube service prometheus-service -n online-library --url"
                echo "Grafana: minikube service grafana-service -n online-library --url"
                echo "Grafana Credentials: admin / admin123"
                echo "=========================================="
            }
        }
    }

    post {
        success {
            echo "Pipeline completed successfully!"
        }
        failure {
            echo "Pipeline failed. Check logs!"
        }
        always {
            echo "Pipeline finished."
            bat "docker image prune -f"
        }
    }
}
