pipeline {
    agent any

    environment {
        // Database
        DB_USERNAME = "root"
        DB_PASSWORD = "tarik123"
        DB_URL = "jdbc:mysql://mysql:3306/online_library?useSSL=false&allowPublicKeyRetrieval=true&serverTimezone=UTC"
        KUBECONFIG = "C:\\Users\\PC\\.kube\\config"

        // Docker
        DOCKER_IMAGE = "onlinebiblio"
        DOCKER_TAG = "${BUILD_NUMBER}"
        DOCKER_REGISTRY = "tarik123abc"

        // Kubernetes
        K8S_NAMESPACE = "online-library"
        K8S_DEPLOYMENT_NAME = "online-library"
        K8S_SERVICE_NAME = "online-library-service"
    }

    stages {

        stage('Clean Workspace') {
            steps {
                echo "Cleaning Jenkins workspace..."
                deleteDir()
            }
        }

        stage('Checkout') {
            steps {
                checkout scm
            }
        }

        stage('Preload Maven Dependencies') {
            steps {
                echo "Preloading Maven dependencies..."
                bat "mvn dependency:go-offline"
            }
        }

        stage('Build & Test') {
            steps {
                echo "Building and testing the application..."
                bat "mvn clean verify"
            }
        }

        stage('Prepare Dependencies for Sonar') {
            steps {
                echo "Copying Maven dependencies..."
                bat "mvn dependency:copy-dependencies -DoutputDirectory=target/dependency"
            }
        }

        stage('SonarQube Analysis') {
            environment {
                SCANNER_HOME = tool name: 'SonarScanner', type: 'hudson.plugins.sonar.SonarRunnerInstallation'
            }
            steps {
                withCredentials([string(credentialsId: 'sonar-token', variable: 'SONAR_AUTH_TOKEN')]) {
                    bat "\"${SCANNER_HOME}\\bin\\sonar-scanner.bat\" " +
                        "-Dsonar.projectKey=onlinebiblio " +
                        "-Dsonar.projectName=OnlineBiblio " +
                        "-Dsonar.sources=src/main/java " +
                        "-Dsonar.tests=src/test/java " +
                        "-Dsonar.java.binaries=target/classes " +
                        "-Dsonar.java.libraries=target/dependency/*.jar " +
                        "-Dsonar.coverage.jacoco.xmlReportPaths=target/jacoco-report/jacoco.xml " +
                        "-Dsonar.host.url=http://localhost:9000 " +
                        "-Dsonar.token=%SONAR_AUTH_TOKEN%"
                }
            }
        }

        stage('Build Docker Image') {
            steps {
                echo "Building Docker image..."
                bat "docker build -t ${DOCKER_IMAGE}:${DOCKER_TAG} ."
                bat "docker tag ${DOCKER_IMAGE}:${DOCKER_TAG} ${DOCKER_IMAGE}:latest"
            }
        }

        stage('Push to Docker Registry') {
            steps {
                echo "Pushing Docker image to Docker Hub..."
                script {
                    withCredentials([usernamePassword(
                        credentialsId: 'docker-hub-credentials',
                        usernameVariable: 'DOCKER_USER',
                        passwordVariable: 'DOCKER_PASS'
                    )]) {
                        bat "docker login -u %DOCKER_USER% -p %DOCKER_PASS%"
                        bat "docker tag ${DOCKER_IMAGE}:${DOCKER_TAG} ${DOCKER_REGISTRY}/${DOCKER_IMAGE}:${DOCKER_TAG}"
                        bat "docker push ${DOCKER_REGISTRY}/${DOCKER_IMAGE}:${DOCKER_TAG}"
                        bat "docker tag ${DOCKER_IMAGE}:${DOCKER_TAG} ${DOCKER_REGISTRY}/${DOCKER_IMAGE}:latest"
                        bat "docker push ${DOCKER_REGISTRY}/${DOCKER_IMAGE}:latest"
                    }
                }
            }
        }
        stage('Deploy to Kubernetes') {
    steps {
        echo "Deploying to Kubernetes..."

        // 1ï¸ Infrastructure de base
        bat "minikube kubectl -- apply -f k8s/namespace.yaml --validate=false"

        // RBAC
        bat "minikube kubectl -- apply -f k8s/prometheus-rbac.yaml --validate=false"

        bat "minikube kubectl -- apply -f k8s/mysql-secret.yaml --validate=false"

        // ConfigMaps & Secrets
        bat "minikube kubectl -- apply -f k8s/mysql-init-configmap.yaml --validate=false"
        bat "minikube kubectl -- apply -f k8s/prometheus-config.yaml --validate=false"
        bat "minikube kubectl -- apply -f k8s/grafana-datasources.yaml --validate=false"
        bat "minikube kubectl -- apply -f k8s/grafana-dashboard.yaml --validate=false"

        // Storage
        bat "minikube kubectl -- apply -f k8s/mysql-pvc.yaml --validate=false"

        // Base de donnÃ©es
        bat "minikube kubectl -- apply -f k8s/mysql-deployment.yaml --validate=false"
        bat "minikube kubectl -- apply -f k8s/mysql-service.yaml --validate=false"

        // ðŸ”¹ Attente robuste MySQL Ready
        echo "Waiting for MySQL pod to be ready..."
        bat """
@echo off
set NAMESPACE=${K8S_NAMESPACE}
for /f %%i in ('minikube kubectl -- get pods -n %NAMESPACE% -l app=mysql -o jsonpath="{.items[0].metadata.name}"') do set POD_NAME=%%i
:WAIT_MYSQL
for /f %%r in ('minikube kubectl -- get pod %POD_NAME% -n %NAMESPACE% -o jsonpath="{.status.containerStatuses[0].ready}"') do set READY=%%r
if "%READY%"=="true" (
    echo MySQL pod is ready âœ…
) else (
    echo Waiting 5 seconds for MySQL...
    timeout /t 5 /nobreak >nul
    goto WAIT_MYSQL
)
"""

        // Application
        bat "minikube kubectl -- apply -f k8s/app-deployment.yaml --validate=false"
        bat "minikube kubectl -- apply -f k8s/app-service.yaml --validate=false"
        bat "minikube kubectl -- set image deployment/${K8S_DEPLOYMENT_NAME} online-library=${DOCKER_REGISTRY}/${DOCKER_IMAGE}:${DOCKER_TAG} -n ${K8S_NAMESPACE}"

        // ðŸ”¹ Attente robuste pour l'application
        echo "Waiting for online-library deployment to be fully ready..."
        bat """
@echo off
set NAMESPACE=${K8S_NAMESPACE}
set DEPLOYMENT=${K8S_DEPLOYMENT_NAME}
:WAIT_APP
for /f %%r in ('minikube kubectl -- get deployment %DEPLOYMENT% -n %NAMESPACE% -o jsonpath="{.status.readyReplicas}"') do set READY=%%r
for /f %%t in ('minikube kubectl -- get deployment %DEPLOYMENT% -n %NAMESPACE% -o jsonpath="{.status.replicas}"') do set TOTAL=%%t
if "%READY%"=="%TOTAL%" (
    echo Deployment %DEPLOYMENT% is fully ready âœ…
) else (
    echo Waiting 5 seconds for deployment...
    timeout /t 5 /nobreak >nul
    goto WAIT_APP
)
"""

        // Monitoring Stack
        echo "Deploying Monitoring Stack..."
        bat "minikube kubectl -- apply -f k8s/kube-state-metrics.yaml --validate=false"
        bat "minikube kubectl -- apply -f k8s/cadvisor-daemonset.yaml --validate=false"
        bat "minikube kubectl -- apply -f k8s/prometheus-deployment.yaml --validate=false"
        bat "minikube kubectl -- apply -f k8s/grafana-deployment.yaml --validate=false"

        // Ingress
        bat "minikube kubectl -- apply -f k8s/ingress.yaml --validate=false"
    }
}


        stage('Verify Deployment') {
            steps {
                echo "Verifying Kubernetes deployment..."
                bat "minikube kubectl -- get pods -n ${K8S_NAMESPACE}"
                bat "minikube kubectl -- get services -n ${K8S_NAMESPACE}"
                bat "minikube kubectl -- get pvc -n ${K8S_NAMESPACE}"
                echo "=========================================="
                echo "APPLICATION URLS:"
                echo "Application: minikube service online-library-service -n online-library --url"
                echo "Prometheus: minikube service prometheus-service -n online-library --url"
                echo "Grafana: minikube service grafana-service -n online-library --url"
                echo "Grafana Credentials: admin / admin123"
                echo "=========================================="
            }
        }
    }

    post {
        success {
            echo "Pipeline completed successfully!"
        }
        failure {
            echo "Pipeline failed. Check logs!"
        }
        always {
            echo "Pipeline finished."
            bat "docker image prune -f"
        }
    }
}
